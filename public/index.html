<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Avaliação 360º - Startup Leiria</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .form-section { margin-bottom: 20px; }
    .hidden { display: none; }
    label { display: block; margin-top: 10px; }
    select, input[type="text"] { width: 100%; max-width: 400px; padding: 6px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px 15px; cursor: pointer; }
    .alert { color: red; }
  </style>
</head>
<body>
  <h1>Avaliação 360º - Startup Leiria</h1>

  <div id="alertBox" class="alert"></div>

  <!-- Secção para escolher o avaliado -->
  <div class="form-section">
    <label for="evaluateeSelect">Selecione quem deseja avaliar (Avaliado):</label>
    <select id="evaluateeSelect"></select>
  </div>
  
  <!-- Dimensões Técnicas (Aparece só se o avaliador tiver permissão) -->
  <div id="technicalSection" class="form-section hidden">
    <h2>Dimensões Técnicas / Profissionais</h2>
    <p>Apenas para gestor direto e/ou pares técnicos relevantes.</p>

    <label for="q1">1. Cumprimento de Objetivos e Metas (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q1">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q2">2. Qualidade e Rigor do Trabalho (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q2">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q3">3. Conhecimento Técnico / Especializado (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q3">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q4">4. Capacidade de Inovação e Melhoria Contínua (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q4">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="techComment">Comentário (opcional):</label>
    <input type="text" id="techComment" placeholder="Detalhes sobre o desempenho técnico">
  </div>

  <!-- Dimensões Comportamentais -->
  <div id="behavioralSection" class="form-section hidden">
    <h2>Dimensões Comportamentais (Soft Skills)</h2>
    <p>Todas as pessoas que trabalhem/interajam com o avaliado podem avaliar estas dimensões.</p>

    <label for="q5">5. Colaboração e Trabalho em Equipa (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q5">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q6">6. Comunicação (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q6">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q7">7. Proatividade e Resolução de Problemas (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q7">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="q8">8. Alinhamento com os Valores/Cultura (1 - Muito abaixo | 5 - Excelente)</label>
    <select id="q8">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="behavioralComment">Comentário (opcional):</label>
    <input type="text" id="behavioralComment" placeholder="Detalhes sobre o desempenho comportamental">
  </div>

  <button id="submitBtn">Submeter Avaliação</button>

  <script>
    let employeesData = [];
    let myId = null; // Quem é o avaliador, detectado pelo token
    let token = null;

    window.onload = () => {
      // Ler o token da query string (ex: ?token=ABC123)
      const params = new URLSearchParams(window.location.search);
      token = params.get('token');

      if (!token) {
        document.getElementById('alertBox').innerText = 
          'Falta o token na URL. Peça ao CEO um link correto.';
        document.getElementById('evaluateeSelect').disabled = true;
        document.getElementById('submitBtn').disabled = true;
        return;
      }

      // Vamos buscar a lista de funcionários + descobrir meu ID via token
      fetch('/get-employees')
        .then(res => res.json())
        .then(data => {
          employeesData = data.employees;

          // Descobrir o meu ID (avaliador) no servidor
          return fetch('/resolve-token?token=' + token);
        })
        .then(res => res.json())
        .then(tokenResp => {
          myId = tokenResp.myId;
          if (!myId) {
            document.getElementById('alertBox').innerText = 
              'Token inválido. Contate o CEO.';
            document.getElementById('evaluateeSelect').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            return;
          }

          // Agora populamos o dropdown de avaliados (excluindo a mim próprio)
          populateEvaluateeSelect(employeesData, myId);
        })
        .catch(err => {
          console.error(err);
          document.getElementById('alertBox').innerText = 
            'Erro ao carregar dados. Tente novamente mais tarde.';
        });

      document.getElementById('evaluateeSelect')
        .addEventListener('change', showRelevantSections);

      document.getElementById('submitBtn')
        .addEventListener('click', handleSubmit);
    };

    function populateEvaluateeSelect(employees, myId) {
      const evaluateeSelect = document.getElementById('evaluateeSelect');
      evaluateeSelect.innerHTML = '';

      const possibleEvaluatees = employees.filter(e => e.id !== myId);
      possibleEvaluatees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = emp.name + ' (' + emp.role + ')';
        evaluateeSelect.appendChild(option);
      });
    }

    function showRelevantSections() {
      const evaluateeId = document.getElementById('evaluateeSelect').value;
      const evaluator = employeesData.find(e => e.id === myId);
      const evaluatee = employeesData.find(e => e.id === evaluateeId);

      if (!evaluatee) return;

      // Dimensão Técnica?
      const isManager = (evaluatee.managerId === myId);
      const isTechnicalPeer = evaluatee.technicalPeers.includes(myId);

      const technicalSection = document.getElementById('technicalSection');
      if (isManager || isTechnicalPeer) {
        technicalSection.classList.remove('hidden');
      } else {
        technicalSection.classList.add('hidden');
      }

      // Dimensão Comportamental?
      const isBehavioralPeer = evaluatee.behavioralPeers.includes(myId);
      const behavioralSection = document.getElementById('behavioralSection');
      if (isBehavioralPeer) {
        behavioralSection.classList.remove('hidden');
      } else {
        behavioralSection.classList.add('hidden');
      }
    }

    function handleSubmit() {
      const evaluateeId = document.getElementById('evaluateeSelect').value;

      if (!evaluateeId) {
        alert('Por favor, selecione um avaliado.');
        return;
      }

      const dataToSubmit = {
        token: token, // para o servidor saber quem sou, mas não visível para mim
        evaluateeId: evaluateeId,
        timestamp: new Date().toISOString(),
        answers: {}
      };

      // Se a secção técnica estiver visível, recolhe as respostas
      if (!document.getElementById('technicalSection').classList.contains('hidden')) {
        dataToSubmit.answers.technical = {
          q1: document.getElementById('q1').value,
          q2: document.getElementById('q2').value,
          q3: document.getElementById('q3').value,
          q4: document.getElementById('q4').value,
          comment: document.getElementById('techComment').value
        };
      }

      // Se a secção comportamental estiver visível, recolhe as respostas
      if (!document.getElementById('behavioralSection').classList.contains('hidden')) {
        dataToSubmit.answers.behavioral = {
          q5: document.getElementById('q5').value,
          q6: document.getElementById('q6').value,
          q7: document.getElementById('q7').value,
          q8: document.getElementById('q8').value,
          comment: document.getElementById('behavioralComment').value
        };
      }

      // Enviar para o servidor
      fetch('/submit-evaluation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSubmit)
      })
      .then(res => {
        if (res.ok) {
          alert('Avaliação submetida com sucesso!');
          // Limpar formulário (opcional)
          document.getElementById('q1').value = 3;
          document.getElementById('q2').value = 3;
          document.getElementById('q3').value = 3;
          document.getElementById('q4').value = 3;
          document.getElementById('techComment').value = '';

          document.getElementById('q5').value = 3;
          document.getElementById('q6').value = 3;
          document.getElementById('q7').value = 3;
          document.getElementById('q8').value = 3;
          document.getElementById('behavioralComment').value = '';
        } else {
          alert('Ocorreu um erro ao submeter. Tente novamente.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Ocorreu um erro ao submeter. Ver console.');
      });
    }
  </script>
</body>
</html>
